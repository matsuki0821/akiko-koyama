---
import Header from '@/components/layout/Header.astro';
import Footer from '@/components/layout/Footer.astro';
import SeoHead from '@/components/layout/SeoHead.astro';
// reCAPTCHA v3 のSite Key（環境変数未設定時のフォールバックを指定）
const siteKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY || '6Lc4NucrAAAAAOBNaeSd4tb0ieXeGEJTbVUJok00';
---
<html lang="ja">
  <SeoHead title="お問い合わせ｜無料相談はこちら – WHOLE LIFE認定講座" description="講座内容や無料相談に関するご質問はこちらから。メールでお気軽にお問い合わせいただけます。返信は迅速に対応いたします。" />
  <body>
    <Header />
    <main class="section py-20">
      <header class="max-w-3xl mx-auto px-4 text-center">
        <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">お問い合わせ</h1>
        <p class="mt-3 text-base-900/70">下記フォームにご入力のうえ送信してください。</p>
      </header>

      <form id="contact-form" method="POST" action="https://ssgform.com/s/El7lhFuUJMBL" class="mt-10 max-w-3xl mx-auto px-4 space-y-6">
        <input type="hidden" name="subject" value="Webサイトからの新規お問い合わせ" />
        <div class="grid gap-6 sm:grid-cols-2">
          <div>
            <label class="block text-sm font-medium">お名前</label>
            <input name="name" class="mt-1 w-full rounded-xl border border-black/10 px-3 py-2" required />
          </div>
          <div>
            <label class="block text-sm font-medium">メールアドレス</label>
            <input type="email" name="email" class="mt-1 w-full rounded-xl border border-black/10 px-3 py-2" required />
          </div>
        </div>

        <fieldset class="rounded-2xl border border-black/10 p-4">
          <legend class="px-1 text-sm font-semibold text-base-900">お問い合わせの種別</legend>
          <div class="mt-2 grid gap-3 sm:grid-cols-2">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" class="h-4 w-4 rounded border-black/30" name="topics" value="next-course" />
              <span>次回の講座開催について</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" class="h-4 w-4 rounded border-black/30" name="topics" value="how-to-apply" />
              <span>お申し込み方法について</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" class="h-4 w-4 rounded border-black/30" name="topics" value="free-consult" />
              <span>無料相談の依頼について</span>
            </label>
          </div>
        </fieldset>

        <div>
          <label class="block text-sm font-medium">お問い合わせ内容</label>
          <textarea name="message" rows={8} class="mt-1 w-full rounded-xl border border-black/10 px-3 py-2" required />
        </div>

        {siteKey ? (
          <input type="hidden" name="g-recaptcha-response" id="g-recaptcha-response" />
        ) : (
          <div class="rounded-xl border border-amber-300 bg-amber-50 text-amber-900 px-3 py-2 text-sm">
            スパム防止（reCAPTCHA v3）を有効化するには、環境変数 <code>PUBLIC_RECAPTCHA_SITE_KEY</code> を設定してください。
          </div>
        )}

        <div class="rounded-2xl bg-black/5 p-4 text-sm text-base-900/80">
          <p>※ フォーム送信後、担当者より詳細のご案内をお送りいたします。</p>
          <p class="mt-1">※ お支払い方法等については、メールにてご案内いたします。</p>
          <p class="mt-1">※ ご不明な点がございましたら、<a href="mailto:info@wholelife-japan.com" class="underline">info@wholelife-japan.com</a>までお問い合わせください。</p>
          <p class="mt-3">個人情報の取り扱いについてをご確認の上、同意いただける場合は「同意する」にチェックをして確認画面にお進みください。</p>
        </div>

        <label class="flex items-start gap-3 text-sm">
          <input type="checkbox" required class="mt-1 h-4 w-4 rounded border-black/30" />
          <span>
            個人情報保護方針に同意します（<a class="underline text-primary" href="/privacy" target="_blank" rel="noopener">プライバシーポリシー</a>）
          </span>
        </label>

        <div class="pt-2">
          <button class="inline-flex items-center justify-center rounded-full bg-primary px-6 py-3 text-white font-semibold shadow-lg ring-1 ring-primary/20 hover:bg-primary-600 hover:shadow-xl transition">送信する</button>
          <p class="mt-3 text-sm text-base-900/70" id="form-status" aria-live="polite"></p>
        </div>
      </form>
    </main>
    <Footer />
    {siteKey && (
      <script src={'https://www.google.com/recaptcha/api.js?render=' + siteKey} async defer></script>
    )}
    <script>
      const form = document.getElementById('contact-form');
      const statusEl = document.getElementById('form-status');
      const recaptchaSiteKey = "{siteKey}";
      if (form && statusEl) {
        // 送信先のオリジンを判定
        let formActionOrigin = null;
        try {
          formActionOrigin = new URL(form.action, location.href).origin;
        } catch {}
        const isSameOrigin = formActionOrigin === location.origin;

        // トークンをhiddenに設定
        const setRecaptchaToken = (token) => {
          let hidden = document.getElementById('g-recaptcha-response');
          if (!hidden) {
            hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'g-recaptcha-response';
            hidden.id = 'g-recaptcha-response';
            form.appendChild(hidden);
          }
          hidden.value = token || '';
        };

        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          // reCAPTCHA v3のトークン取得
          if (!window.grecaptcha || !recaptchaSiteKey) {
            statusEl.textContent = 'reCAPTCHAの初期化に失敗しました。時間をおいて再度お試しください。';
            return;
          }

          statusEl.textContent = '検証中です…';
          let token = '';
          try {
            await window.grecaptcha.ready(async () => {});
            token = await window.grecaptcha.execute(recaptchaSiteKey, { action: 'submit' });
            setRecaptchaToken(token);
          } catch (err) {
            statusEl.textContent = 'reCAPTCHAの検証に失敗しました。もう一度お試しください。';
            return;
          }

          if (isSameOrigin) {
            // 同一オリジンのときのみAJAX送信
            statusEl.textContent = '送信中です…';
            const submitBtn = form.querySelector('button[type="submit"], button');
            if (submitBtn) submitBtn.disabled = true;
            try {
              const formData = new FormData(form);
              const res = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json' }
              });
              if (res.ok) {
                statusEl.textContent = '送信が完了しました。担当者より折り返しご連絡いたします。';
                form.reset();
              } else {
                statusEl.textContent = '送信に失敗しました。恐れ入りますが、時間をおいて再度お試しください。';
              }
            } catch (err) {
              statusEl.textContent = 'ネットワークエラーが発生しました。接続をご確認のうえ再度お試しください。';
            } finally {
              const submitBtn = form.querySelector('button[type="submit"], button');
              if (submitBtn) submitBtn.disabled = false;
            }
          } else {
            // 外部オリジンは通常送信
            form.submit();
          }
        });
      }
    </script>
  </body>
</html>


